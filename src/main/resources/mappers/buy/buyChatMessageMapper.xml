<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring.erp_ordit.dao.buy.BuyChatMessageMapper"> <!-- 채팅 -->

	<!-- 직원 목록 조회 -->
	<select id="chatEmployeeList" resultType="com.spring.erp_ordit.dto.buy.ChatEmployeeDTO">
		SELECT 
			et.e_id, 
		    et.e_name,
		    eat.e_auth_id
		FROM employee_tbl et
		LEFT JOIN employee_auth_tbl eat ON et.e_id = eat.e_id
	</select>

	<!-- 존재하는 room_id 조회 -->
	<select id="existsByRoomId" resultType="boolean">
		SELECT EXISTS (
		SELECT 1 FROM chat_room_tbl WHERE room_id = #{room_id}
		)
	</select>

	<!-- 채팅방 없으면 생성 -->
	<insert id="insertRoom">
		INSERT INTO chat_room_tbl (room_id, user1_id, user2_id, created_at)
		VALUES (#{room_id}, #{user1_id}, #{user2_id}, NOW())
	</insert>

	<!-- 메시지 입력 -->
	<insert id="insertMessage"
		parameterType="com.spring.erp_ordit.dto.buy.BuyChatMessageDTO">
		INSERT INTO chat_message_tbl (room_id, sender, content, type, receiver,
		created_at)
		VALUES (#{room_id}, #{sender}, #{content}, #{type}, #{receiver}, NOW())
	</insert>

	<!-- 채팅 내역 조회 -->
	<select id="selectMessagesByRoomId" parameterType="String" resultType="com.spring.erp_ordit.dto.buy.BuyChatMessageDTO">
		SELECT * FROM chat_message_tbl
		WHERE room_id = #{room_id}
		ORDER BY created_at ASC
	</select>

</mapper>   